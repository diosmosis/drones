{# TODO: use underscores for all internal variables #}
package {{ builder.getContext().getActivityPackage() }};

import com.flarestar.drones.base.Drone;
import com.flarestar.drones.base.BaseScreen;
import com.flarestar.drones.views.viewgroups.BoxModelNode;
import com.flarestar.drones.views.scope.Scope;
import com.flarestar.drones.views.ViewFactory;
import com.flarestar.drones.views.ScopedViewFactory;
import com.flarestar.drones.views.viewgroups.BaseDroneViewGroup;
import com.flarestar.drones.views.viewgroups.DynamicViewGroup;
import com.flarestar.drones.views.viewgroups.dynamic.SingleViewFactory;
import com.flarestar.drones.views.viewgroups.dynamic.RangeViewFactory;
import com.flarestar.drones.views.scope.Listener;
import com.flarestar.drones.views.scope.watcher.Watcher;
import com.flarestar.drones.views.LayoutBuilder;
import com.flarestar.drones.views.aspect.ScrollingAspect;
import com.flarestar.drones.routing.ActivityRouter;
import android.view.View;
import android.view.ViewGroup;
import android.os.Handler;
import javax.inject.Inject;
import javax.inject.Singleton;
import java.util.concurrent.Callable;
import {{ builder.getContext().getApplicationPackage() }}.R;

@Singleton
public class {{ builder.getContext().getLayoutBuilderSimpleClassName() }} implements Drone, LayoutBuilder {

    private ViewFactory[] _toTransclude;

    @Inject
    ActivityRouter $location;

    {% for property in builder.getInjectedProperties() %}
    @Inject
    {{ property.type }} {{ property.name }};
    {% endfor %}

    {% for directiveTree in builder.getIsolateDirectiveTrees() %}
    {% render directiveTree.getScopeInterface() %}{% endrender %}
    {% endfor %}

    {% for definition in builder.getScopeDefinitions() %}
    {% render definition %}{% endrender %}
    {% endfor %}

    private Handler _handler;

    @Inject
    public {{ builder.getContext().getLayoutBuilderSimpleClassName() }}() {
        _handler = new Handler();
    }

    public void setUpDrone(final BaseScreen screen) {
        if (!(screen instanceof {{ builder.getContext().getActivityClassName }})) {
            return;
        }

        final DynamicViewGroup rootView = (DynamicViewGroup)makeView_{{ builder.getRootViewId() }}(screen);
        rootView.getScope().apply();
        screen.setContentView(rootView);

        _toTransclude = null;
    }

    {% render builder.getRootMakeViewMethod() %}{% endrender %}

    {% for directiveTree in builder.getIsolateDirectiveTrees() %}
    {% render directiveTree.getDirectiveMakeView() %}{% endrender %}
    {% endfor %}

    {% for function in builder.getUserFunctions() %}
    {% render function %}{% endrender %}
    {% endfor %}
}
