{% macro directive_hook(view, generationContext, hookName) %}
{% for directive in view.directives %}{{ directive.getHookCode(hookName, generationContext) }}{% endfor %}
{% endmacro %}

{% macro make_view_function(view, interpolator, styleProcessor, generationContext) %}
{% import _self as self %}

    private {% if view.hasDynamicDirective() %}ViewFactory{% else %}View{% endif %} makeView_{{ view.id }}(final BaseScreen _screen{% if view.parent != null %}, final DynamicViewGroup _parentView, final Scope _parentNodeScope{% endif %}) {
        {% if view.parent != null %}final {{ view.parent.getScopeDefinition().getScopeClassName() }} scope = ({{ view.parent.getScopeDefinition().getScopeClassName() }})_parentNodeScope;
        {% if view.parent.getScopeDefinition().getParentScope() != null %}final {{ view.parent.getScopeDefinition().getParentScope().getScopeClassName() }} _parent = scope._parent;{% endif %}
        {% for property in view.getScopeDefinition().properties %}final {{ property.type }} {{ property.name }} = scope.{{ property.name }};
        {% endfor %}{% endif %}

    {% if view.hasDynamicDirective() %}
        final ViewFactory result = new ViewFactory() {
            public void createViews(final ViewGroup parent) {
    {% endif %}

        {{ self.directive_hook(view, generationContext, "beforeScopeCreated") }}

        View result = new ScopedViewFactory() {
            @Override
            public View make() {

                final {{ view.getViewClassName() }} result = new {{ view.getViewClassName() }}(_screen);

                {% if view.hasScope() %}final {{ view.getScopeDefinition().getScopeClassName() }} scope = {% if view.hasIsolateScope() %}new {{ view.getScopeDefinition().getScopeClassName() }}(_handler, result{% if node.parent != null %}, _parentNodeScope{% endif %}){% else %}({{ view.getScopeDefinition().getScopeClassName() }})_parentNodeScope{% endif %};
                {% if view.getScopeDefinition().getParentScope() != null %}final {{ view.getScopeDefinition().getParentScope().getScopeClassName() }} _parent = scope._parent;{% endif %}
                {% for property in view.getScopeDefinition().properties %}{% if not property.isInherited %}final {{ property.type }} {{ property.name }} = scope.{{ property.name }};
                {% endif %}{% endfor %}{% endif %}

                {{ self.directive_hook(view, generationContext, "beforeViewCreated") }}

                result.setVisibility(View.VISIBLE);
                {% if view.hasScope() %}
                if (result instanceof ScopedViewGroup) {
                    ((ScopedViewGroup)result).setScope(scope);
                }
                {% endif %}
                {% if view.text != null and not view.text.isEmpty() %}result.setText({{ interpolator.interpolate(view.text) }});{% endif %}
                {{ styleProcessor.process(view) }}

                {{ self.directive_hook(view, generationContext, "afterViewCreated") }}

                {% for child in view.children %}
                result.{% if view.isDynamic() %}addChildDefinition{% else %}addView{% endif %}(makeView_{{ child.id }}(_screen, result, scope));
                {% endfor %}

                {{ self.directive_hook(view, generationContext, "afterChildrenAdded") }}

                return result;
            }
        }.make();

    {% if view.hasDynamicDirective() %}parent.addView(result);

                {{ self.directive_hook(view, generationContext, "afterViewAdded") }}
            }
        };
    {% endif %}

        {{ self.directive_hook(view, generationContext, "beforeReturnResult") }}

        return result;
    }

    {% for child in view.children %}
    {{ self.make_view_function(child, interpolator, styleProcessor, generationContext) }}
    {% endfor %}
{% endmacro %}