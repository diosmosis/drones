{% macro directive_hook(view, hookName) %}
{% for directive in view.directives %}{{ directive.getHookCode(hookName, view) }}{% endfor %}
{% endmacro %}

{% macro make_view_function(view, interpolator, styleProcessor, typeInferer) %}
{% import _self as self %}

    private {% if view.hasDynamicDirective() %}ViewFactory{% else %}View{% endif %} makeView_{{ view.id }}(final BaseScreen _screen{% if view.parent != null %}, final DynamicViewGroup _parentView, final {{ view.parent.scopeDefinition.getScopeClassName() }} _parentNodeScope{% endif %}) {
        {% if view.parent != null %}final {{ view.parent.scopeDefinition.getScopeClassName() }} scope = _parentNodeScope;
        {% if view.parent.scopeDefinition.getParentScope() != null %}final {{ view.parent.scopeDefinition.getParentScope().getScopeClassName() }} _parent = scope._parent;{% endif %}
        {% for property in view.parent.scopeDefinition.allProperties() %}final {{ property.type }} {{ property.name }} = {{ property.accessCode() }};
        {% endfor %}{% endif %}

    {% if view.hasDynamicDirective() %}
        final ViewFactory result = new ViewFactory() {
            public void createViews(final ViewGroup parent) {
    {% endif %}

        {{ self.directive_hook(view, "beforeScopeCreated") }}

        View result = new ScopedViewFactory() {
            @Override
            public View make() {

                final {{ view.getViewClassName() }} result = _viewRecycler.makeView({{ view.getViewClassName() }}.class, "{{ view.getSignature()|escape("js") }}", _screen);

                {% if view.hasScope() %}final {{ view.scopeDefinition.getScopeClassName() }} scope = {% if not view.scopeDefinition.isPassthroughScope() %}new {{ view.scopeDefinition.getScopeClassName() }}(_handler, result{% if view.parent != null %}, _parentNodeScope{% endif %}){% else %}({{ view.scopeDefinition.getScopeClassName() }})_parentNodeScope{% endif %};
                {% if view.scopeDefinition.getParentScope() != null %}final {{ view.scopeDefinition.getParentScope().getScopeClassName() }} _parent = scope._parent;{% endif %}
                {% for property in view.scopeDefinition.ownProperties() %}final {{ property.type }} {{ property.name }} = scope.{{ property.name }};
                {% endfor %}{% endif %}

                {{ self.directive_hook(view, "beforeViewCreated") }}

                result.setVisibility(View.VISIBLE);
                {% if view.hasScope() and typeInferer.isAssignable(view.getViewClassName(), "com.flarestar.drones.views.viewgroups.ScopedViewGroup") %}
                ((ScopedViewGroup)result).setScope(scope);
                {% endif %}

                {% if view.text != null and not view.text.isEmpty() %}result.setText({{ interpolator.interpolate(view.text) }});{% endif %}
                {{ styleProcessor.process(view) }}

                {{ self.directive_hook(view, "afterViewCreated") }}

                {% for child in view.children %}
                result.{% if view.isDynamic() %}addChildDefinition{% else %}addView{% endif %}(makeView_{{ child.id }}(_screen, result, scope));
                {% endfor %}

                {{ self.directive_hook(view, "afterChildrenAdded") }}

                return result;
            }
        }.make();

    {% if view.hasDynamicDirective() %}parent.addView(result);

                {{ self.directive_hook(view, "afterViewAdded") }}
            }
        };
    {% endif %}

        {{ self.directive_hook(view, "beforeReturnResult") }}

        return result;
    }

    {% for child in view.children %}
    {{ self.make_view_function(child, interpolator, styleProcessor, typeInferer) }}
    {% endfor %}
{% endmacro %}